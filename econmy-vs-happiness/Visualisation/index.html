<!DOCTYPE html>
<meta charset="utf-8">

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title> IS428 Project </title>
</head>

<style>
    /***********
    * Stylesheet
    ************/

    html { min-height: 1000px; }

    /* For Zoom Scatter Plot */
    .point { stroke: black; }
    .selected { stroke: yellow; }
    .axis { font: 10px sans-serif; }

    p {
        font: 12px sans-serif;
        margin: 0 0 2px 0;
        padding: 0;
    }

    .clear-button {
        font: 14px sans-serif;
        cursor: pointer;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .brush .extent {
        stroke: #fff;
        fill-opacity: .125;
        shape-rendering: crispEdges;
    }

    #selectButton {
        position: relative;
        /* float: right; */
        top: 90px;
        left: 77%;
    }

    .zoom-chart { margin-left: 15%; }

    /* Slider */
    .whole-slider {
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

	input[type='range'] {
		-webkit-appearance: none !important;
		-webkit-border-radius: 5px;
		background-color: rgb(53, 135, 212);
		height: 10px;
		width: 600px;
		margin: 20px;
        margin-bottom: 2em;
	}

	input[type='range']::-webkit-slider-thumb {
		-webkit-appearance: none !important;
		-webkit-border-radius: 15px;
		background-color: #bbb;
		background-image: -webkit-gradient(linear, left top, left bottom, from(#bbb), to(#888));
		border: 1px solid #000;
		height: 25px;
		width: 25px;
	}

    /*Chart*/
	body { font: 10px sans-serif; }

	.axis path, .axis line {
		fill: none;
		stroke: #000;
		shape-rendering: crispEdges;
	}

	.dot {
		stroke: #000;
		stroke-width: 1;
	}

	.dot:hover { stroke: #bbb; }
	#range { font: 15px sans-serif; }

	div.tooltip {
		position: absolute;
		text-align: left;
		padding: 2px;
		font: 12px sans-serif;
		background: #EDEDED;
		border: 0px;
		border-radius: 8px;
		pointer-events: none;
	}

	table {
		border-collapse: collapse;
		width: 400px;
		margin-left: 0px;
	}

	.chart {
		width: 100%;
		height: 500px;
	}

    button {
		width: 4em;
		height: 2em;
		background: black;
		border: 1px solid black;
		border-radius: 4px;
		color: white;
		font-size: 1.5em;
	}

    #title {
        font-weight: bold;
        font-size: larger;
    }

    .filters {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
        background-color: lightgray;
        border-radius: 4px;
    }

    .filter {
		width: 6em;
		background: black;
        color: white;
		border: 1px solid black;
		font-size: 12px;
        margin-left: 15px;
	}

	h4 {
		text-align: center;
		margin-bottom: .5em;
		margin-top: .5em;
	}

	.label { font-size: 1.2em; }
	#schoolinfo { position: absolute; }

    #chartTitle {
        text-align: center;
        padding-top: 15px;
     }

    /* Legend */
    .region-name { margin: 0 !important; }

    .key-dot {
        display: inline-block;
        height: 10px;
        margin-right: .5em;
        width: 10px;
    }

    #legend {
        overflow: hidden;
        /* Legend Position */
        position: relative;
        left: 1300px;
        top: -350px;
    }

    .legend {
        float: middle;
        margin-right: 1em;
        margin-left: 1.5em;
    }

    .legend2 {
        float:left;
        margin-left: 11%;
        margin-right: 1em;
        width: 250px;
    }

    /*Responsive CSS*/
	@media only screen and (min-width: 481px) {
		.chart {
			width: 100%;
			height: 500px;
		}

		table{
			width:500px;
			margin-left: 10%;
		}

		h3, h4{ margin-left: 20%; }
        h3{ font-size: 16pt; }

        #legend {
            overflow: hidden;
            position: relative;
            left: 600px;
            top: -350px;
        }
	}

	@media only screen and (min-width: 769px) {
		.chart {
			width: 100%;
			height: 600px;
		}

		table{
			width:700px;
			left: -20px;
			margin-left: 15%;
		}

		h3, h4 { margin-left: 20%; }
		h3 { font-size: 16pt; }

        #legend {
            overflow: hidden;
            position: relative;
            left: 650px;
            top: -350px;
        }
	}

    @media only screen and (min-width: 865px) {
        .whole-slider { width: 90%; }
	}

    @media only screen and (min-width: 1000px) {
        .whole-slider { width: 55%; }

        #legend {
            overflow: hidden;
            position: relative;
            left: 900px;
            top: -350px;
        }
	}

</style>

<body>

    <h1 id="chartTitle">How Economy Affected World Happiness Through Time</h1>
    <div class="whole-slider">
        <input id="slider" type="range" min="2015" max="2022" value="2015" step="1"/>
        <span id="range">2015</span>
        <button name="play" id="play">Play</button>
        <div class="filters">
            <div class="filters" id="title">Filters:</div>
            <button class="filter" id="top10">Top 10</button>
            <select id="selectButton-xaxis" style="margin-left: 2.5em;"></select>
        </div>
    </div>
	<div id="chart"></div>
    <div id="legend">
        <div class="legend-title" id="title" style="margin-bottom: 10px; margin-left: 2.5em;">Region</div>
        <div class="legend">
            <p class="region-name"></p>
        </div>
    </div>

    <select id="selectButton"></select>
    <div class="legend5"></div>

	<script src="https://d3js.org/d3.v3.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

    <script>

        $(document).ready(function()	{


            /**************************
            * Chart Layout
            * (1) Margin, Height, Width
            * (2) X Axis & Scales
            * (3) Y Axis & Scales
            * (4) Color Scale
            ***************************/

            var margin = { top : 20, right : 20, bottom : 30, left : 40 },
                width = 725 - margin.left - margin.right,
                height = 600 - margin.top - margin.bottom;

            var x = d3.scale.linear()
                .range([0, width]);

            var y = d3.scale.linear()
                .range([height, 0]);

            var div = d3.select("body")
                .append("div")
                    .attr("id", "schoolinfo")
                    .style("opacity", 0);

            var color = d3.scale.category10();

            var xAxis = d3.svg.axis()
                .scale(x)
                .orient("bottom");

            var yAxis = d3.svg.axis()
                .scale(y)
                .orient("left");

            var svg = d3.select("#chart")
                .append("svg")
                    .attr("class", "chart")
                    .attr("viewBox", "0 0 725 600")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")


            d3.csv("WHR_by_years.csv", prepare, function(error, data) {

                /*******************
                * Axis Value Range *
                *******************/

                const economy_label_2015 = Array.from(new Set(data.map(d => +d.economy_2015)))
                const economy_label_2016 = Array.from(new Set(data.map(d => +d.economy_2016)))
                const economy_label_2017 = Array.from(new Set(data.map(d => +d.economy_2017)))
                const economy_label_2018 = Array.from(new Set(data.map(d => +d.economy_2018)))
                const economy_label_2019 = Array.from(new Set(data.map(d => +d.economy_2019)))
                const economy_label_2020 = Array.from(new Set(data.map(d => +d.economy_2020)))
                const economy_label_2021 = Array.from(new Set(data.map(d => +d.economy_2021)))
                const economy_label_2022 = Array.from(new Set(data.map(d => +d.economy_2022)))
                const economy_total = economy_label_2015.concat(
                    [economy_label_2016, economy_label_2017, economy_label_2018, economy_label_2019,
                    economy_label_2020, economy_label_2021, economy_label_2022]);

                const hs_label_2015 = Array.from(new Set(data.map(d => +d.hs_2015)))
                const hs_label_2016 = Array.from(new Set(data.map(d => +d.hs_2016)))
                const hs_label_2017 = Array.from(new Set(data.map(d => +d.hs_2017)))
                const hs_label_2018 = Array.from(new Set(data.map(d => +d.hs_2018)))
                const hs_label_2019 = Array.from(new Set(data.map(d => +d.hs_2018)))
                const hs_label_2020 = Array.from(new Set(data.map(d => +d.hs_2020)))
                const hs_label_2021 = Array.from(new Set(data.map(d => +d.hs_2021)))
                const hs_label_2022 = Array.from(new Set(data.map(d => +d.hs_2022)))
                const hs_total = hs_label_2015.concat(
                    [hs_label_2016, hs_label_2017, hs_label_2018, hs_label_2019,
                    hs_label_2020, hs_label_2021, hs_label_2022]);

                x.domain([0, d3.max(economy_total) + 0.8]).nice();
                y.domain([0, d3.max(hs_total) + 1.2]).nice();

                /*********
                * X Axis *
                **********/

                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis)
                    .append("text")
                        .attr("class", "label")
                        .attr("x", width)
                        .attr("y", -6)
                        .style("text-anchor", "end")
                        .text("Economy");

                /*********
                * Y Axis *
                **********/

                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                    .append("text")
                        .attr("class", "label")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 6)
                        .attr("dy", ".71em")
                        .style("text-anchor", "end")
                        .text("Happiness Score");


                /****************************
                * Chart Legend *
                * (1) Legend Values - Region
                * (2) Color
                * (3) Text
                * (4) Filter Interaction
                ****************************/

                legendVals = d3.set(data.map( function(d) { return d.region } ) ).values()

                var legend = d3.select('.legend')
                    .selectAll("legend")
                    .data(legendVals)

                legend.enter().append("div").attr("class","legend")

                var p = legend.append("p").attr("class","country-name")
                p.append("circle").attr("class","key-dot").style("background", function(d,i) { return color(i) })
                p.insert("text").text( function(d,i) { return d })

                // (4) Filter Interaction
                legend.on("click", function(name) {

                    colorList = []
                    colorList_unclicked = []

                    if(d3.select(this).classed('clicked')) {
                        d3.select(this).classed('clicked', false);
                        d3.select(this).classed('unclicked', true);
                        d3.select(this).style('opacity', 1);

                        var no_of_unclicked_regions = $(".legend.unclicked");
                        for(var i=0; i< no_of_unclicked_regions.length; i++){
                            backgroundColor = no_of_unclicked_regions[i].children[0].childNodes[0].style.background
                            if (colorList_unclicked.includes(backgroundColor) != true) {
                                colorList_unclicked.push(backgroundColor)
                            }
                            d3.selectAll(".dot")
                                .filter(function(){
                                    if (colorList_unclicked.indexOf($(this).css('fill')) > -1) {
                                        return ( $(this).css('fill') );
                                    }
                                })
                                .style("opacity",1)
                        }
                    } else {
                        d3.select(this).classed('clicked', true);
                        d3.select(this).classed('unclicked', false);
                        d3.select(this).style('opacity', 0.7);

                        var no_of_clicked_regions = $(".legend.clicked");
                        for(var i=0; i< no_of_clicked_regions.length; i++){
                            backgroundColor = no_of_clicked_regions[i].children[0].childNodes[0].style.background
                            if (colorList.includes(backgroundColor) != true) {
                                colorList.push(backgroundColor)
                            }
                            d3.selectAll(".dot")
                                .filter(function(){
                                    if (colorList.indexOf($(this).css('fill')) > -1) {
                                        return ( $(this).css('fill') );
                                    }
                                })
                                .style("opacity",0.1)
                        }
                    }
                });


                /***************
                * Tooltip *
                * (1) Hover
                * (2) Move
                * (3) Leave cell
                ****************/

                var Tooltip = d3.select("#chart")
                    .append("div")
                    .style("opacity", 0)
                    .attr("class", "tooltip")
                    .style("background-color", "white")
                    .style("border", "solid")
                    .style("border-width", "2px")
                    .style("border-radius", "5px")
                    .style("padding", "5px")

                var mouseover = function(d) {
                    Tooltip
                    .style("opacity", 1)
                    d3.select(this)
                    .style("stroke", "yellow")
                }

                currentSliderValue = $("#slider").val();

                var mousemove = function(d) {
                    Tooltip
                    .html("Country: " + d.country + tooltipText(currentSliderValue,d))
                    .style("left", (d3.mouse(this)[0]+50) + "px")
                    .style("top", (d3.mouse(this)[1]) + "px")
                }

                var mouseleave = function(d) {
                    Tooltip
                    .style("opacity", 0)
                    d3.select(this)
                    .style("stroke", "black")
                }


                /*****************
                * Add Datapoints *
                ******************/

                svg.selectAll(".dot")
                    .data(data)
                    .enter()
                    .append("circle")
                        .attr("class", "dot")
                        .attr("r", function(d) { return ((d.hs_2015 + d.hs_2016 + d.hs_2017 + d.hs_2018 + d.hs_2019 + d.hs_2020 + d.hs_2021 + d.hs_2022) * 0.5)  })
                        .attr("cx", function(d) { return x(d.economy_2015); })
                        .attr("cy", function(d) { return y(d.hs_2015); })
                        .style("fill", function(d){ return color(d.region) })
                    .on("mouseover", mouseover)
                    .on("mousemove", mousemove)
                    .on("mouseleave", mouseleave);


                /*****************************
                * Slider & Buttons *
                * (1) On-click
                * (2) Update Values
                * (3) Clear Interval
                *****************************/


                var running = false;
                var timer;

                $("button#play").on("mouseover", function() {
                    $("button#play").css("background-color",'rgb(53, 135, 282)');
                });

                $("button#play").on("mouseleave", function() {
                    if (running == false) {
                        $("button#play").css("background-color",'black');
                    } else {
                        $("button#play").css("background-color",'rgb(53, 135, 212)');
                    }
                });

                $("button#play").on("click", function() {
                    var duration = 2000,
                        maxstep = 2022,
                        minstep = 2015;

                    if (running == true) {
                        $("button#play").html("Play");
                        $("button#play").css("background-color",'rgb(53, 135, 282)');
                        running = false;
                        clearInterval(timer);
                    } else if (running == false) {
                        $("button#play").html("Pause");
                        sliderValue = $("#slider").val();
                        timer = setInterval( function(){
                            if (sliderValue < maxstep){
                                sliderValue++;
                                $("#slider").val(sliderValue);
                                $('#range').html(sliderValue);
                            }
                            $("#slider").val(sliderValue);
                            update();
                        }, duration);
                        running = true;
                    }
                });

                $("#slider").on("change", function(){
                    $("#range").html($("#slider").val());
                    update();
                    tooltipText();
                    $("#range").html($("#slider").val());
                    clearInterval(timer);
                    $("button#play").html("Play");
                });

                flag = false;
                $("button#top10").on("mouseover", function() {
                    $("button#top10").css("background-color",'rgb(53, 135, 282)');
                    $("button#top10").css("color",'white');
                });

                $("button#top10").on("mouseleave", function() {
                    if (flag == false) {
                        $("button#top10").css("background-color",'black');
                    } else {
                        $("button#top10").css("background-color",'rgb(53, 135, 212)');
                    }
                });

                $("button#top10").on("click", function() {
                    if (flag == true && $("button#top10").css('background-color') !== "rgb(255, 0, 0)") {
                        $("button#top10").css("background-color",'black');
                        flag = false;
                        switch ($("#slider").val()) {
                            case $("#slider").val():
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return (d.hr_2015);
                                    })
                                    .style("opacity",1)
                            case "2016":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return (d.hr_2016);
                                    })
                                .style("opacity",1)
                            case "2017":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return (d.hr_2017);
                                    })
                                .style("opacity",1)
                            case "2018":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return (d.hr_2018);
                                    })
                                .style("opacity",1)
                            case "2019":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return (d.hr_2019);
                                    })
                                .style("opacity",1)
                            case "2020":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return (d.hr_2020);
                                    })
                                .style("opacity",1)
                            case "2021":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return (d.hr_2021);
                                    })
                                .style("opacity",1)
                            case "2022":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return (d.hr_2022);
                                    })
                                    .style("opacity",1)
                        }
                    } else {
                        flag = true; // WHEN BUTTON IS CLICKED
                        $("button#top10").css("background-color",'rgb(53, 135, 212)');
                        $("button#top10").css("color",'white');
                        switch ($("#slider").val()) {
                            case $("#slider").val():
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return ( d.hr_2015 > 10);
                                    })
                                    .style("opacity",0.1)
                            case "2016":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return ( d.hr_2016 > 10);
                                    })
                                .style("opacity",0.1)
                            case "2017":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return ( d.hr_2017 > 10);
                                    })
                                .style("opacity",0.1)
                            case "2018":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return ( d.hr_2018 > 10);
                                    })
                                .style("opacity",0.1)
                            case "2019":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return ( d.hr_2019 > 10);
                                    })
                                .style("opacity",0.1)
                            case "2020":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return ( d.hr_2020 > 10);
                                    })
                                .style("opacity",0.1)
                            case "2021":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return ( d.hr_2021 > 10);
                                    })
                                .style("opacity",0.1)
                            case "2022":
                                d3.selectAll(".dot")
                                    .filter(function(d,i){
                                        return ( d.hr_2022 > 10);
                                    })
                                    .style("opacity",0.1)
                        }
                    }
                });


                /*****************************
                * Update Tooltip *
                * (1) Rank
                * (2) Happiness Score
                * (3) Economy (GDP per Capita)
                *****************************/

                tooltipText = function(year, d) {
                    switch ($("#slider").val()) {
                        case "2015":
                            return "<br>Rank: " + d.hr_2015 + "<br>Happiness Score: " + d.hs_2015 + "<br>Economy (GDP per Capita): " + d.economy_2015;
                        case "2016":
                            return "<br>Rank: " + d.hr_2016 + "<br>Happiness Score: " + d.hs_2016 + "<br>Economy (GDP per Capita): " + d.economy_2016;
                        case "2017":
                            return "<br>Rank: " + d.hr_2017 + "<br>Happiness Score: " + d.hs_2017 + "<br>Economy (GDP per Capita): " + d.economy_2017;
                        case "2018":
                            return "<br>Rank: " + d.hr_2018 + "<br>Happiness Score: " + d.hs_2018 + "<br>Economy (GDP per Capita): " + d.economy_2018;
                        case "2019":
                            return "<br>Rank: " + d.hr_2019 + "<br>Happiness Score: " + d.hs_2019 + "<br>Economy (GDP per Capita): " + d.economy_2019;
                        case "2020":
                            return "<br>Rank: " + d.hr_2020 + "<br>Happiness Score: " + d.hs_2020 + "<br>Economy (GDP per Capita): " + d.economy_2020;
                        case "2021":
                            return "<br>Rank: " + d.hr_2021 + "<br>Happiness Score: " + d.hs_2021 + "<br>Economy (GDP per Capita): " + d.economy_2021;
                        case "2022":
                            return "<br>Rank: " + d.hr_2022 + "<br>Happiness Score: " + d.hs_2022 + "<br>Economy (GDP per Capita): " + d.economy_2022;
                    }
                }

                update = function() {

                    d3.selectAll(".dot")
                        .transition()
                        .duration(1000)
                        .attr("cy", function(d) {
                            switch ($("#slider").val()) {
                                case "2015":
                                    return y(d.hs_2015);
                                    break;
                                case "2016":
                                    return y(d.hs_2016);
                                    break;
                                case "2017":
                                    return y(d.hs_2017);
                                    break;
                                case "2018":
                                    return y(d.hs_2018);
                                    break;
                                case "2019":
                                    return y(d.hs_2019);
                                    break;
                                case "2020":
                                    return y(d.hs_2020);
                                    break;
                                case "2021":
                                    return y(d.hs_2021);
                                    break;
                                case "2022":
                                    return y(d.hs_2022);
                                    break;
                            }
                        })
                        .transition()
                        .duration(1000)
                        .attr("cx", function(d) {
                            switch ($("#slider").val()) {
                                case "2015":
                                    return x(d.economy_2015);
                                    break;
                                case "2016":
                                    return x(d.economy_2016);
                                    break;
                                case "2017":
                                    return x(d.economy_2017);
                                    break;
                                case "2018":
                                    return x(d.economy_2018);
                                    break;
                                case "2019":
                                    return x(d.economy_2019);
                                    break;
                                case "2020":
                                    return x(d.economy_2020);
                                    break;
                                case "2021":
                                    return x(d.economy_2021);
                                    break;
                                case "2022":
                                    return x(d.economy_2022);
                                    break;
                            }
                        });
                };

            });


            /*****************
            * Dataset Fields *
            ******************/

            function prepare(d) {
                return {
                    country: d.Country,
                    region: d.Region,

                    hr_2015: +d.HappinessRank_2015,
                    hs_2015: +d.HappinessScore_2015,
                    economy_2015: +d.Economy_2015,
                    family_2015: +d.Family_2015,
                    health_2015: +d.Health_2015,
                    freedom_2015: +d.Freedom_2015,
                    trust_2015: +d.Trust_2015,
                    generosity_2015: +d.Generosity_2015,

                    hr_2016: +d.HappinessRank_2016,
                    hs_2016: +d.HappinessScore_2016,
                    economy_2016: +d.Economy_2016,
                    family_2016: +d.Family_2016,
                    health_2016: +d.Health_2016,
                    freedom_2016: +d.Freedom_2016,
                    trust_2016: +d.Trust_2016,
                    generosity_2016: +d.Generosity_2016,

                    hr_2017: +d.HappinessRank_2017,
                    hs_2017: +d.HappinessScore_2017,
                    economy_2017: +d.Economy_2017,
                    family_2017: +d.Family_2017,
                    health_2017: +d.Health_2017,
                    freedom_2017: +d.Freedom_2017,
                    trust_2017: +d.Trust_2017,
                    generosity_2017: +d.Generosity_2017,

                    hr_2018: +d.HappinessRank_2018,
                    hs_2018: +d.HappinessScore_2018,
                    economy_2018: +d.Economy_2018,
                    family_2018: +d.Family_2018,
                    health_2018: +d.Health_2018,
                    freedom_2018: +d.Freedom_2018,
                    generosity_2018: +d.Generosity_2018,

                    hr_2019: +d.HappinessRank_2019,
                    hs_2019: +d.HappinessScore_2019,
                    economy_2019: +d.Economy_2019,
                    family_2019: +d.Family_2019,
                    health_2019: +d.Health_2019,
                    freedom_2019: +d.Freedom_2019,
                    generosity_2019: +d.Generosity_2019,

                    hr_2020: +d.HappinessRank_2020,
                    hs_2020: +d.HappinessScore_2020,
                    economy_2020: +d.Economy_2020,
                    family_2020: +d.Family_2020,
                    health_2020: +d.Health_2020,
                    freedom_2020: +d.Freedom_2020,
                    generosity_2020: +d.Generosity_2020,

                    hr_2021: +d.HappinessRank_2021,
                    hs_2021: +d.HappinessScore_2021,
                    economy_2021: +d.Economy_2021,
                    family_2021: +d.Family_2021,
                    health_2021: +d.Health_2021,
                    freedom_2021: +d.Freedom_2021,
                    generosity_2021: +d.Generosity_2021,

                    hr_2022: +d.HappinessRank_2022,
                    hs_2022: +d.HappinessScore_2022,
                    economy_2022: +d.Economy_2022,
                    family_2022: +d.Family_2022,
                    health_2022: +d.Health_2022,
                    freedom_2022: +d.Freedom_2022,
                    generosity_2022: +d.Generosity_2022,
                };
            }

        });
    </script>


<script>


    /*************
    * Zoom Chart *
    *************/

    d3.helper = {};


    /**********
    * Tooltip *
    ***********/

    d3.helper.tooltip = function(){
        var tooltipDiv;
        var bodyNode = d3.select('body').node();

        function tooltip(selection){

            selection.on('mouseover.tooltip', function(data, pI){

                d3.select('body').selectAll('div.tooltip').remove(); // Clean up lost tooltips

                // Append tooltip
                tooltipDiv = d3.select('body')
                               .append('div')
                               .attr('class', 'tooltip')

                var absoluteMousePos = d3.mouse(bodyNode);

                tooltipDiv.style({
                    left: (absoluteMousePos[0] + 10)+'px',
                    top: (absoluteMousePos[1] - 40)+'px',
                    'background-color': '#d8d5e4',
                    width: '200px',
                    height: '120px',
                    padding: '5px',
                    position: 'absolute',
                    'z-index': 1001,
                    'box-shadow': '0 1px 2px 0 #656565'
                });

                var first_line = '<p>Country: ' + data.country + '</p>'
                var second_line = '<p>Rank Difference: ' + data.region + '</p>'
                var third_line = '<p>Happiness Score: ' + data.hs + '</p>'
                var third2_line = '<p>Economy: ' + data.economy + '</p>'
                var fourth_line = '<p>Year: ' + data.year + '</p>'
                var fifth_line = '<p>Rank: ' + data.hr + '</p>'
                var sixth_line = '<p>Rank Difference: ' + data.diffRank + '</p>'

                tooltipDiv.html(first_line + second_line + third_line + third2_line + fourth_line + fifth_line + sixth_line)

            })
            .on('mousemove.tooltip', function(pD, pI){
                var absoluteMousePos = d3.mouse(bodyNode); // Move tooltip
                tooltipDiv.style({
                    left: (absoluteMousePos[0] + 10)+'px',
                    top: (absoluteMousePos[1] - 40)+'px'
                });
            })
            .on('mouseout.tooltip', function(pD, pI){
                tooltipDiv.remove(); // Remove tooltip
            });

        }

        tooltip.attr = function(_x){
            if (!arguments.length) return attrs;
            attrs = _x;
            return this;
        };

        tooltip.style = function(_x){
            if (!arguments.length) return styles;
            styles = _x;
            return this;
        };

        return tooltip;
    };


    d3.csv("WHR.csv", prepare, function(error, data) {

        var allGroup = d3.map(data, function(d){return(d.year)}).keys()  // List of Years
        allGroup.unshift('All') // Add a default "All" selection option

        // Add the options to the button
        d3.select("#selectButton")
            .selectAll('myOptions')
            .data(allGroup)
            .enter()
            .append('option')
            .text(function (d) { return d; }) // Text shown in the menu
            .attr("value", function (d) { return d; }) // Corresponding value returned by the button

        // Add 'selected-option' to first option button
        $('#selectButton > option')[0].setAttribute("id", "selected-option");

        var margin = {top: 20, right: 20, bottom: 60, left: 40},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        const economy_list = Array.from(new Set(data.map(d => +d.economy)))
        const happinessScore_list = Array.from(new Set(data.map(d => +d.hs)))

        var x = d3.scale.linear()
            .range([0, width])
            .domain([0, d3.max(economy_list) + 0.8]).nice();

        var y = d3.scale.linear()
            .range([height, 0])
            .domain([0, d3.max(happinessScore_list) + 1.2]).nice();

        var color = d3.scale.category10();

        var brush = d3.svg.brush()
            .x(x)
            .on("brush", brushmove)
            .on("brushend", brushend);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .ticks(11);

        var svg = d3.select("body").append("svg")
            .attr("class", "zoom-chart")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        svg.append("g")
            .attr("class", "x axis")
            .attr("clip-path", "url(#clip)")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
            .append("text")
                .attr("class", "label")
                .attr("dy", "2.5em")
                .attr("dx", "70em")
                .text("Economy");

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
                .attr("class", "label")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Happiness Score");

        svg.append("g")
            .attr("class", "brush")
            .call(brush)
            .selectAll('rect')
            .attr('height', height);

        svg.append("defs").append("clipPath")
            .attr("id", "clip")
            .append("rect")
            .attr("width", width)
            .attr("height", height + 20);

        points = svg.selectAll(".point")
            .data(data)
            .enter().append("circle")
            .attr("class", "point")
            .attr("clip-path", "url(#clip)")
            .attr("r", function(d){ return ((d.hs) * 1.5); })
            .attr("cx", function(d) { return x(d.economy); })
            .attr("cy", function(d) { return y(d.hs); })
            .style("fill", function(d){ return color(d.region); })
            .call(d3.helper.tooltip());

        points.on('mousedown', function(){
            brush_elm = svg.select(".brush").node();
            new_click_event = new Event('mousedown');
            new_click_event.pageX = d3.event.pageX;
            new_click_event.clientX = d3.event.clientX;
            new_click_event.pageY = d3.event.pageY;
            new_click_event.clientY = d3.event.clientY;
            brush_elm.dispatchEvent(new_click_event);
        });


        // A function which update the chart
        function update(selectedGroup) {
            if (selectedGroup == "All") {
            d3.selectAll(".point")
                .filter(function(d){ return d.hr != -1 })
                .style("opacity",1)
            } else {
            d3.selectAll(".point")
                .filter(function(d){ {return d.year!=selectedGroup}})
                .style("opacity",0.1)
            }
        }

        // When the button is changed, run the updateChart function
        d3.select("#selectButton").on("change", function(d) {
            var selectedOption = d3.select(this).property("value") // Recover the option that has been chosen
            update(selectedOption) // Run the updateChart function with this selected option
        })


        function brushmove() {
            var extent = brush.extent();
            points.classed("selected", function(d) {
            is_brushed = extent[0] <= d.economy && d.economy <= extent[1];
            return is_brushed;
            });
        }

        function brushend() {
            get_button = d3.select(".clear-button");
            if(get_button.empty() === true) {
            clear_button = svg.append('text')
                .attr("y", 470)
                .attr("x", 825)
                .attr("class", "clear-button")
                .text("Clear Brush");
            }

            x.domain(brush.extent());

            transition_data();
            reset_axis();

            points.classed("selected", false);
            d3.select(".brush").call(brush.clear());

            clear_button.on('click', function(){
            x.domain([0, d3.max(economy_list) + 0.8]).nice();
            transition_data();
            reset_axis();
            clear_button.remove();
            });
        }

        function transition_data() {
            svg.selectAll(".point")
            .data(data)
            .transition()
            .duration(500)
            .attr("cx", function(d) { return x(d.economy); });
        }

        function reset_axis() {
            svg.transition().duration(500)
            .select(".x.axis")
            .call(xAxis);
        }

        /****************************
        * Chart Legend *
        * (1) Legend Values - Region
        * (2) Color
        * (3) Text
        ****************************/

        legendLabel = d3.set(data.map( function(d) { return d.region } ) ).values()

        var legend5 = d3.select('.legend5').selectAll("legend")
            .data(legendLabel)

        legend5.enter().append("div")
        .attr("class","legend2")

        var p = legend5.append("p").attr("class","country-name")
        p.append("span").attr("class","key-dot").style("background",function(d,i) { return color(i) } )
        p.insert("text").text(function(d,i) { return d } )


    });

    /*****************
    * Dataset Fields *
    ******************/

    function prepare(d) {
        return {
            country: d.Country,
            region: d.Region,
            year: d.Year,
            diffRank: +d.Difference_in_Rank,
            hr: +d.Rank,
            hs: +d.Happiness_score,
            economy: +d.Economy,
            family: +d.Family,
            health: +d.Health,
            freedom: +d.Freedom,
            trust: +d.Government,
            generosity: +d.Generosity,
        };
    }


    </script>
